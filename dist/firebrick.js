/*!
* Firebrick JS - JavaScript MVC Framework powered by jQuery and Knockout JS
* Author: Steven Masala
* dependencies: jquery, knockout js
* contact: me@smasala.com
*/

(function(e,t){typeof define=="function"&&define.amd?define(["jquery","knockout","knockout-mapping"],function(e,n,r){return n.mapping=r,t(e,n)}):t(e.jQuery,e.ko)})(this,function(e,t){if(window.Firebrick||window.fb){console.error("unable to initialise FirebrickJS, window.Firebrick or window.fb are already defined");return}var n={version:"0.8.27",app:{name:"",path:""},ready:function(t){var r=this;r.app=t.app,r.utils.initSplash(t.splash||r.templates.loadingTpl),n.boot.prepApplication(t),t.require&&t.require.length>0?(e.isArray(t.require)||(t.require=[t.require]),require(t.require,function(){r.utils.clearSplash();var n=arguments;e(document).ready(function(){t.go.apply(t.go,n)})})):(r.utils.clearSplash(),e(document).ready(function(){t.go()}))},shortcut:function(e,t,n){return e[t].apply(e,n)},get:function(){return this.shortcut(this.classes,"get",arguments)},getById:function(){return this.shortcut(this.classes,"getById",arguments)},create:function(){return this.shortcut(this.classes,"create",arguments)},define:function(){return this.shortcut(this.classes,"define",arguments)},createController:function(){return this.shortcut(this.controllers,"createController",arguments)},require:function(){return this.shortcut(this.utils,"require",arguments)},loadRaw:function(){return this.shortcut(this.views,"loadRaw",arguments)},createView:function(){return this.shortcut(this.views,"createView",arguments)},defineView:function(){return this.shortcut(this.views,"defineView",arguments)},getBody:function(){return this.shortcut(this.views,"getBody",arguments)},delay:function(){return this.shortcut(this.utils,"delay",arguments)},addListener:function(){return this.shortcut(this.events,"addListener",arguments)},removeListener:function(){return this.shortcut(this.events,"removeListener",arguments)},fireEvent:function(){return this.shortcut(this.events,"fireEvent",arguments)},on:function(){return this.shortcut(this.events,"on",arguments)},off:function(){return this.shortcut(this.events,"off",arguments)},createStore:function(){return this.shortcut(this.data.store,"createStore",arguments)},text:function(){return this.shortcut(this.languages,"getByKey",arguments)},classes:{classRegistry:{},get:function(e){return this.classRegistry[e]},getById:function(t){var n=this,r;return e.each(n.classRegistry,function(e,n){if(n._classId&&n.getClassId&&n.getClassId()==t)return r=n,!1}),r},extend:function(t,n){var r={};for(p in t)t.hasOwnProperty(p)&&(r[p]=Object.getOwnPropertyDescriptor(t,p),n[p]&&e.isFunction(n[p])&&(r[p].value=function(e,t){return function(){this.callParent=t;var n=e.apply(this,arguments);return delete this.callParent,n}}(r[p].value,n[p])));var i=Object.create(n);return Object.create(Object.getPrototypeOf(i),r)},create:function(e,t,n){var r=this,i;return r.classRegistry[e]?i=r.extend(t,r.classRegistry[e]):i=r.define(e,t),i.init&&i.init(),i},_initMixins:function(t){var r=this;if(t.mixins){var i=function(t,r){return e.isPlainObject(r)?r._mixedIn||(r._mixedIn=!0,n.utils.overwrite(t,r)):typeof r=="string"&&(r=n.create(r),r||new Error("unable to find mixin",t.mixins),r._mixedIn=!0,n.utils.overwrite(t,r)),r};if(e.isArray(t.mixins))for(var s=0,o=t.mixins.length;s<o;s++)t.mixins[s]=i(t,t.mixins[s]);else t.mixins=i(t,t.mixins)}return t},define:function(e,t){var n=this,r;if(t.extend){var i=n.classRegistry[t.extend];r=n.extend(t,i)}else r=Object.create(t);return r=n._initMixins(r),e&&(n.classRegistry[e]=r),r.constructor&&r.constructor(e),r}},controllers:{createController:function(e,t){return t=t||{},t.extend="Firebrick.controller.Base",n.create(e,t)}},templates:{loadingTpl:"<div class='fb-view-loader'><span class='glyphicon glyphicon-refresh glyphicon-refresh-animate'></span></div>"},views:{bootView:function(e){return n.utils.clearSplash(),n.createView(n.app.name+".view.Index",{target:"body",store:e.viewData,async:!0,listeners:{ready:function(){n.fireEvent("viewReady",this)}}})},createView:function(t,r){return t&&!r&&(e.isPlainObject(t)?(r=t,t=null):r={}),r=this.basicViewConfigurations(r),n.create(t,r)},defineView:function(e,t){var r=this;return t=r.basicViewConfigurations(t),n.define(e,t)},initSubViews:function(t){var n=this,r=t.subViews;return r&&(e.isArray(r)?e.each(r,function(e,r){t.subViews[e]=n.internal_loadSubView(r)}):t.subViews=n.internal_loadSubView(r)),t},internal_loadSubView:function(t){if(e.type(t)=="string")t=n.createView(t,{autoRender:!1});else if(e.isPlainObject(t)&&t.isView)if(t._state=="unbound")t=t.render();else{var r=n.createView(t._classname);t=r,n.classes.classRegistry[t._classname]=r}return t},loadRaw:function(e){var t=this,r;return n.utils.require(e,function(e){r=e},!1,"html","html"),r},basicViewConfigurations:function(e){var t=this;return e=e||{},e.extend||(e.extend="Firebrick.view.Base"),e},_body:null,getBody:function(t){var n=this;if(t===!0||!n._body)n._body=e("body");return n._body},getTarget:function(t){var n=t&&t.jquery?t:e(t);return n.length>0?n:null},renderTo:function(e,t,n){return n===!0?e.append(t):e.html(t)}},boot:{prepApplication:function(t){t.cache===!1&&(require.config({urlArgs:"fb="+(new Date).getTime()}),e.ajaxSetup({cache:!1})),t.dev&&(requirejs.onError=function(e){e.requireType==="timeout"?console.log("modules: "+e.requireModules):console.error(e.message)}),t.lang&&n.languages.init(t.lang),t.autoRender!==!1&&n.views.bootView(t)}},utils:{requiredFiles:{},intervalRegistry:{},splashCleared:!1,initSplash:function(t){var r=this;n.delay(function(){r.splashCleared||e("html").append("<div id='fb-splash'>"+t+"</div>")},1)},clearSplash:function(){this.splashCleared=!0,e("#fb-splash").remove()},overwrite:function(t,n,r){var i=this;return e.each(n,function(e,n){t[e]=n}),t},merge:function(t,n,r){var i=this,s=Object.getPrototypeOf(r||n);return s.hasOwnProperty(t)&&(e.each(s[t],function(e,r){e in n[t]||(n[t][e]=r)}),i.merge(t,n,s)),n},delay:function(e,t,n,r){setTimeout(function(t){e.apply(r||this,t)},t,n)},clearInterval:function(e){var t=this,n=t.intervalRegistry[e];n&&(window.clearInterval(n.intId),delete this.intervalRegistry[e])},setInterval:function(){var t=this,n=arguments[0],r=e.isFunction(n)?n.id:n,i;return t.isIntervalRunning(r)||(e.isFunction(n)?i=t.int_applyInterval(null,arguments[0],arguments[1],arguments[2]):i=t.int_applyInterval.apply(this,arguments)),i},int_applyInterval:function(e,t,n,r){var i=this;e=e||i.uniqId();var s=function(){t.id=e,t.apply(r||t,arguments)};return s.intId=window.setInterval(s,n),i.intervalRegistry[e]=s,e},isIntervalRunning:function(e){return this.intervalRegistry[e]},clone:function(t,n){var r={};return n=n||{},e.each(t,function(e,t){r[e]=t}),e.each(n,function(e,t){r[e]=t}),r},require:function(t,n,r,i,s){var o=this,u,a={};i=i||"script",s=s||"js",e.isArray(t)||(t=[t]);var f=t;t=f.filter(function(e){return!o.requiredFiles[e]});var l=t.length,c=function(){l--,l===0&&n&&e.isFunction(n)&&n.apply(this,arguments)};return e.each(t,function(n,f){o.requiredFiles[f]=!0,u=o.getPathFromName(f,s),e.ajax({async:e.type(r)=="boolean"?r:!0,dataType:i,url:u,success:function(){t.length>1?(a[f]=arguments,c.call(this,a)):c.apply(this,arguments)},error:function(e,t,n){console.warn("unable to load file/class '",f,"' at:",u),console.error(t,n),c.apply(this,arguments)}})}),t},getPathFromName:function(e,t){var r=this,i=n.app.path,s=n.app.name;return t=t||"js",i.charAt(i.length-1)=="/"&&(i=i.substr(0,i.length-1)),e=e.trim(),e.indexOf(".")>0&&e.indexOf(s)===0?(e=e.replace(s,i),e.replace(/\./g,"/")+"."+t):i+"/"+e},_globalC:1,uniqId:function(){var e=this,t=new Date,n=t.getMilliseconds()+"",r=++t+n+(++e._globalC===1e4?e._globalC=1:e._globalC);return r},loadCSS:function(e){var t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=e,document.getElementsByTagName("head")[0].appendChild(t)}},languages:{lang:t.observable("en"),keys:t.observable({}),init:function(t){var r=this;e.type(t)=="string"?n.createStore({url:t,autoLoad:!1}).load({callback:function(){r.keys(this.getData())}}):t.isStore?r.keys=t.getData():console.error("unable to load languages",t)},getByKey:function(t){t=e.isFunction(t)?t():t;var n=this,r=t.toLowerCase(),i=n.keys()[n.lang()];return i&&i[r]?i[r]:t},setLang:function(e){this.lang(e)},getLang:function(){return this.lang()},allLanguages:function(){var n=this,r=[];return e.each(t.mapping.toJS(n.keys),function(e){r.push(e)}),r}},events:{eventRegistry:{},eventCounter:0,addListener:function(t,n,r){var i=this;return e.isPlainObject(t)?i.addListener_internal(t):n.conf?n:(n.conf={},n.conf.callbackId=i.eventCounter++,n.conf.scope=r,i.eventRegistry[t]||(i.eventRegistry[t]=[]),i.eventRegistry[t].push(n),n)},addListener_internal:function(t){var n=this,r=t.scope;delete t.scope,e.each(t,function(e,t){n.addListener(e,t,r)})},removeListener:function(e,t){var n=this,r=n.eventRegistry[e];if(r)if(t.conf.callbackId||t.conf.callbackId===0)for(var i=0,s=r.length;i<s;i++)r[i].conf.callbackId==t.conf.callbackId&&(r.splice(i,1),r.length===0&&delete n.eventRegistry[e]);else console.warn("No callbackId for function whilst trying to remove listener");else console.warn("Unable to remove listener. No events found for:",e)},fireEvent:function(e){var t=this,n=t.eventRegistry[e];if(n){var r=[].splice.call(arguments,1),i=t.createEventData(e);for(var s=0,o=n.length;s<o;s++){var u=n[s];i.conf=u.conf,i.funct=u,r.unshift(i),u.apply(u.conf.scope||window,r)}}},createEventData:function(e){var t=this,n={event:e,conf:null,removeSelf:function(){t.removeListener(e,n.funct)}};return n},on:function(t,n,r,i){var s=this;return e.isPlainObject(t)?s.on_internal(t):s.register_on_event(t,n,r,i)},off:function(t,n,r){e(document.body).off(t,n,r)},on_internal:function(t){var n=this,r=t.scope;e.each(t,function(t,i){t!="scope"&&e.each(i,function(e,i){n.register_on_event(e,t,i,r)})})},register_on_event:function(t,n,r,i){e(document).on(t,n,function(){var e=[].splice.call(arguments,0);e.push(this),r.apply(i||this,e)})}},data:{store:{createStore:function(t,r){var i=this;if(e.type(t)=="string"){var s=n.get(t);return s?(s=n.classes.extend(r,s),s.init()):(r=i.basicStoreConfigurations(r),s=n.create(t,r)),s}r=t||{};var o=n.get("Firebrick.store.Base");return n.classes.extend(r,o).init()},basicStoreConfigurations:function(e){var t=this;return e=e||{},e.extend||(e.extend="Firebrick.store.Base"),e},loadStore:function(t,n){n=n||{};var r=this,i=t.url,s=n.async;return e.type(s)!="boolean"&&(s=t.async),e.isPlainObject(i)&&(i=i.get),t.status="preload",e.ajax({datatype:t.datatype,async:s,url:t.url,success:function(r,i,s){t.setData(r),t.status=i,e.isFunction(n.callback)&&n.callback.apply(n.scope||t,[t,r,i,s])},error:function(e,n,r){console.warn("unable to load store '",t.classname,"' with path:",t.url),console.error(n,r)}}),t},submit:function(t,n){var r=this,i;return t&&t.url&&t.url.submit?(t.status="presubmit",i=t.toJson(),e.ajax({url:t.url.submit,data:{data:t.toJson()},type:t.protocol,beforeSend:function(){return t.fireEvent("beforeSubmit",t,i)},success:function(e,r,i){t.status=r,n&&n.apply(t,arguments)},error:function(){console.error("error submitting data for store to url",t.url.submit,t)}})):console.error("unable to submit store, no submit path found (url.submit)",t),t}}},router:{set:function(t){var r=this,i=function(){};return e.isFunction(t)?i=t:e.isPlainObject(t)&&(i=function(){e.each(t,function(e,t){if(n.router.is("#"+e))return t.apply(this,arguments),!1})}),r.onHashChange(i)},onHashChange:function(t){return e(window).on("hashchange",function(){t.apply(this,arguments)})},is:function(e){return e.indexOf("#")!==-1?window.location.hash==e:window.location.href.replace(window.location.origin)==e}}};return n.define("Firebrick.class.Base",{constructor:function(e){var t=this;e&&(t._classname=e)},init:function(){var t=this;return t.listeners&&(n.utils.merge("listeners",t),e.each(t.listeners,function(n,r){e.isFunction(r)&&(t.listeners[n]=function(){return r.apply(this,arguments)})}),t.on(t.listeners)),t.fireEvent(t.overrideReadyEvent||"ready"),t},mixins:null,_idPrefix:"fb-",_classId:null,localEventRegistry:null,getClassId:function(){var e=this;return e._classId||(e._classId=e._idPrefix+n.utils.uniqId()),e._classId},listeners:null,on:function(t,r,i){var s=this;s.localEventRegistry||(s.localEventRegistry={});var o=function(e,t,r){s.localEventRegistry[e]||(s.localEventRegistry[e]=[]),t.id=n.utils.uniqId(),r&&(t.scope=r),s.localEventRegistry[e].push(t)};if(e.isPlainObject(t)){var u=t.scope||s;e.each(t,function(e,t){e!=="scope"&&e!=="abc"&&o(e,t,u)})}else i=i||s,o(t,r,i);return s},off:function(t,n){var r=this;return r.localEventRegistry&&r.localEventRegistry[t]&&e.each(r.localEventRegistry[t],function(e,i){if(i.id==n.id)return r.localEventRegistry[t].splice(e,1),!1}),r},fireEvent:function(){var t=this,n=t.localEventRegistry,r=arguments,i=arguments[0];return n&&n[i]&&e.each(n[i],function(e,t){t.apply(t.scope||t,r)}),t},passEvent:function(){return this.fireEvent.apply(this,arguments[0])}}),n.define("Firebrick.view.Base",{extend:"Firebrick.class.Base",tpl:"",store:null,html:"",target:null,autoRender:!0,controller:null,loadingTpl:n.templates.loadingTpl,loading:!1,showLoading:!0,_state:"initial",subViews:null,isView:!0,viewExtension:"html",async:!0,items:null,appendContent:!1,_init:function(t){var r=this;r.autoRender&&r.startLoader(),r.items&&(n.ui?r.tpl=n.ui.build({items:r.items,view:r}):console.error("in order to use the items property please add Firebrick UI"));if(!r.tpl){var i=n.utils.require(r._classname,function(e){r.tpl=e,t.call()},r.async,"html",r.viewExtension);i.length||t.call()}else e.isFunction(r.tpl)&&(r.tpl=r.tpl.call(r)),t.call();return this},init:function(){var e=this;return e.overrideReadyEvent="base",e.on(e.overrideReadyEvent,function(){e._init(function(){e.initStore(),e.initView(),e.fireEvent("ready")})}),e.callParent()},getStore:function(){return this.store},getData:function(){return this.getStore().getData()},initView:function(){var e=this;return e.html=e.tpl,e.autoRender&&e.render(),e},initSubViews:function(){return n.views.initSubViews(this)},getTarget:function(){return n.views.getTarget(this.target)},unbind:function(){var e=this,n=e.getTarget();if(n&&n.attr("fb-view-bind")){var r=n[0];t.cleanNode(r),n.removeAttr("fb-view-bind")}},bind:function(){var r=this,i=r.getTarget();if(i&&!i.attr("fb-view-bind")){var s=i[0];n.views.renderTo(i,r.html,r.appendContent),r.hide(),r._state="rendered";var o=r.getData();o&&!e.isEmptyObject(o)&&(i.attr("fb-view-bind",r.getClassId()),t.applyBindings(o,s),r.setDisposeCallback(s)),r.stopLoader(),r.show(),r.fireEvent("rendered",r)}},render:function(){var e=this,t=e.getTarget();return t?(e.fireEvent("beforeRender",e),e.unbind(),e.bind(),e.initSubViews()):console.warn("unable to render, no target found for",e.target,this),e},setDisposeCallback:function(r){t.utils.domNodeDisposal.addDisposeCallback(r,function(t){var r=n.getById(e(t).attr("fb-view-bind"));r.unbound()})},unbound:function(){this._state="unbound",this.fireEvent("unbound",this)},show:function(){var e=this,t=e.getTarget();t&&t.show()},hide:function(){var e=this,t=e.getTarget();t&&t.hide()},isVisible:function(){var e=this,t=e.getTarget();return t?t.is(":visible"):!1},initStore:function(){var e=this;return e.store=e.store||{},e.store.isStore||(e.store=n.createStore({data:e.store})),e},update:function(e){var t=this;return t.getStore().setData(e),t},startLoader:function(){var e=this,t=e.getTarget();!e.loading&&t&&(e.loading=!0,n.delay(function(){e.loading&&(e.hide(),t.before("<div id='fb-loader-"+e.getClassId()+"'>"+e.loadingTpl+"</div>"))},1))},stopLoader:function(){var t=this;t.loading&&(e("#fb-loader-"+t.getClassId()).remove(),t.show(),t.loading=!1)}}),n.define("Firebrick.controller.Base",{extend:"Firebrick.class.Base",init:function(){return this.callParent()},app:{on:function(){return n.events.on.apply(n.events,arguments)},listeners:function(){return n.events.addListener.apply(n.events,arguments)}}}),n.define("Firebrick.store.Base",{extend:"Firebrick.class.Base",init:function(){var e=this;return e.dataInitialised||(e.autoLoad?e.load():e.data&&e.setData(e.data)),this.callParent()},datatype:"json",url:{get:null,submit:null},protocol:"POST",status:"initial",isStore:!0,dataInitialised:!1,autoLoad:!1,data:null,_initialData:null,async:!0,root:null,load:function(e){return n.data.store.loadStore(this,e)},getData:function(){var t=this;return t.root&&e.isPlainObject(t.data)?e.isFunction(t.data[t.root])?t.data[t.root]():t.data[t.root]:t.data},getRawData:function(n){var r=this;if(n)return r._initialData;var i=r.getData();return i=e.isFunction(i)?i():i,t.toJS(i)},setData:function(e){var n=this;return n.dataInitialised?e.__ko_mapping__?console.error("cannot update store data using a mapped object",e):(n._initialData=e,t.mapping.fromJS(e,n.data)):(e.__ko_mapping__||(n._initialData=e,e=t.mapping.fromJS(e)),n.data=e,n.dataInitialised=!0),n},submit:function(){return n.data.store.submit(this)},toPlainObject:function(){var n=this;return e.isFunction(n.data)?t.toJS(n.data):n.data},toJson:function(){return JSON.stringify(this.toPlainObject())}}),window.Firebrick=n,window.fb=window.Firebrick,n});