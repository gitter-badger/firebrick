/**
* Firebrick JS - JavaScript MVC Framework powered by jQuery, Bootstrap and Knockout JS
* Author: Steven Masala
* dependencies: jquery, rivets.js
* contact: me@smasala.com
*/ 

(function(e,t,n){if(e.Firebrick){console.error("unable to initialise FirebrickJS, Firebrick already defined");return}var r={version:"0.3.1",app:{name:"",path:""},ready:function(e){var r=this;r.app=e.app,whenReady=r.utils.whenReady(e);r.utils.initSplash(e.splash||r.templates.loadingTpl);if(e.require&&e.require.length>0){if(!n.isArray(e.require)){e.require=[e.require]}n.each(e.require,function(e,t){r.create(t)});n(t).ready(whenReady)}else{n(t).ready(whenReady)}},shortcut:function(e,t,n){return e[t].apply(e,n)},get:function(){return this.shortcut(this.classes,"get",arguments)},create:function(){return this.shortcut(this.classes,"create",arguments)},define:function(){return this.shortcut(this.classes,"define",arguments)},require:function(){return this.shortcut(this.utils,"require",arguments)},getView:function(){return this.shortcut(this.view,"getView",arguments)},createView:function(){return this.shortcut(this.view,"createView",arguments)},defineView:function(){return this.shortcut(this.view,"defineView",arguments)},getBody:function(){return this.shortcut(this.view,"getBody",arguments)},delay:function(){return this.shortcut(this.utils,"delay",arguments)},addListener:function(){return this.shortcut(this.events,"addListener",arguments)},removeListener:function(){return this.shortcut(this.events,"removeListener",arguments)},fireEvent:function(){return this.shortcut(this.events,"fireEvent",arguments)},on:function(){return this.shortcut(this.events,"on",arguments)},off:function(){return this.shortcut(this.events,"off",arguments)},createStore:function(){return this.shortcut(this.data.store,"createStore",arguments)},createRecord:function(){return this.shortcut(this.data.record,"createRecord",arguments)},classes:{classRegistry:{},get:function(e,t){return this.createClass(e,t)},create:function(e,t){var n=this,r=n.get(e,t);if(r.init){r.init()}return r},createClass:function(e,t){var i=this;if(n.isPlainObject(e)){return e}if(!i.classRegistry[e]){r.utils.require(e,function(){if(i.classRegistry[e].hasDependencies&&i.classRegistry[e].hasDependencies()){var s=i.classRegistry[e].require;if(!n.isArray(s)){s=[s]}n.each(s,function(e,t){i.create(t)})}if(t){i.classRegistry[e]=r.utils.extend(i.classRegistry[e],t)}},false)}return i.classRegistry[e]},define:function(e,t){var n=this,r=n.buildClass(e,t);n.classRegistry[e]=r;return r},buildClass:function(e,t){var n=this,t=t||{};if(t.extend){var i=n.classRegistry[t.extend];if(i){t=r.utils.extend(t,i);t._super=i}else{console.warn("unable to find parent class to inherit from:",t.extend)}}var s=t;s._classname=e;return s}},templates:{loadingTpl:"<div class='fb-view-loader'><span class='glyphicon glyphicon-refresh glyphicon-refresh-animate'></span></div>"},view:{viewRegistry:{},viewExtension:"html",getView:function(e){return this.defineView(e)},createView:function(e,t){var n=this,r=n.defineView(e,t).init();return r},defineView:function(e,t){var n=this;if(!n.viewRegistry[e]){t=n.basicViewConfigurations(t);var i=r.classes.buildClass(e,t);n.viewRegistry[e]=i;if(i.showLoading===true){var s=n.getTarget(i.target);if(s){s.html(i.loadingTpl)}}r.utils.require(e,function(e){t.tpl=e},false,"html",n.viewExtension)}return n.viewRegistry[e]},basicViewConfigurations:function(e){var t=this;e=e||{};if(!e.extend){e.extend="Firebrick.view.Base";if(!e.init){e.init=function(){return this.callParent()}}}return e},body:null,getBody:function(e){var t=this;if(e===true||!t.body){t.body=n("body")}return t.body},getTarget:function(e){var t=e&&e.jquery?e:n(e);return t.length>0?t:null},renderTo:function(e,t){return e.html(t)}},utils:{requiredFiles:{},initSplash:function(e){n("html").append("<div class='fb-splash'>"+e+"</div>");n(t).ready(function(){n("div.fb-splash").remove()})},whenReady:function(e){var t=this;return function(){if(e.autoRender!==false){var t=r.createView(r.app.name+".view.Index",{target:"body",data:e.initialData});r.fireEvent("main-viewRendered",t)}if(n.isFunction(e.go)){e.go()}}},extend:function(e,t){var r=this;n.each(t,function(t,r){if(!e.hasOwnProperty(t)){e[t]=r}else{if(n.isFunction(e[t])){(function(n,r){e[t]=function(){this.callParent=r;var e=n.apply(this,arguments);delete this.callParent;return e}})(e[t],r)}}});return e},overwrite:function(e,t){n.each(t,function(t,n){e[t]=n});return e},delay:function(e,t,n,r){setTimeout(function(){e.apply(n||this)},t)},clone:function(e,t){var r={},t=t||{};n.each(e,function(e,t){r[e]=t});n.each(t,function(e,t){r[e]=t});return r},require:function(e,t,r,i,s){var o=this,u,i=i||"script",s=s||"js";if(!n.isArray(e)){e=[e]}var a=e;e=a.filter(function(e){return!o.requiredFiles[e]});var f=e.length,l=function(){f--;if(f==0){if(t&&n.isFunction(t)){t.apply(this,arguments)}}};for(var c=0,h=e.length;c<h;c++){o.requiredFiles[e]=true;u=o.getPathFromName(e[c],s);n.ajax({async:n.type(r)=="boolean"?r:true,dataType:i,url:u,success:function(){l.apply(this,arguments)},error:function(t,n,r){console.warn("unable to load file/class '",e[c],"' at:",u);console.error(n,r);l.apply(this,arguments)}})}},getPathFromName:function(e,t){var n=this,i=r.app.path,s=r.app.name,t=t||"js";if(i.charAt(i.length-1)=="/"){i=i.substr(0,i.length-1)}e=e.trim();if(e.indexOf(".")>0){if(e.indexOf(s)==0){e=e.replace(s,i);return e.replace(/\./g,"/")+"."+t}}return i+"/"+e},globalC:1,uniqId:function(){var e=this,t=new Date,n=t.getMilliseconds()+"",r=++t+n+(++e.globalC===1e4?e.globalC=1:e.globalC);return r}},events:{eventRegistry:{},eventCounter:0,addListener:function(e,t,r){var i=this;if(n.isPlainObject(e)){return i.addListener_internal(e)}if(!t.conf){t.conf={};t.conf.callbackId=i.eventCounter++}t.conf.scope=r;if(!i.eventRegistry[e]){i.eventRegistry[e]=[]}i.eventRegistry[e].push(t);return t},addListener_internal:function(e){var t=this,r=e.scope;delete e.scope;n.each(e,function(e,n){t.addListener(e,n,r)})},removeListener:function(e,t){var n=this,r=n.eventRegistry[e];if(r){if(t.conf.callbackId||t.conf.callbackId==0){for(var i=0,s=r.length;i<s;i++){if(r[i].conf.callbackId==t.conf.callbackId){r.splice(i,1);if(r.length==0){delete n.eventRegistry[e]}}}}else{console.warn("No callbackId for function whilst trying to remove listener")}}else{console.warn("Unable to remove listener. No events found for:",e)}},fireEvent:function(t,n){var r=this,i=r.eventRegistry[t];if(i){var s=[].splice.call(arguments,1),o=r.createEventData(t);s.unshift(o);for(var u=0,a=i.length;u<a;u++){var f=i[u];o.conf=f.conf;o.funct=f;s.unshift(o);f.apply(f.conf.scope||e,s)}}},createEventData:function(e){var t=this,n={event:e,conf:null,removeSelf:function(){t.removeListener(e,n.funct)}};return n},on:function(e,t,r,i){var s=this;if(n.isPlainObject(e)){return s.on_internal(e)}return s.register_on_event(e,t,r,i)},off:function(e,r,i){n(t.body).off(e,r,i)},on_internal:function(e){var t=this,r=e.scope;n.each(e,function(e,i){if(e!="scope"){n.each(i,function(n,i){t.register_on_event(n,e,i,r)})}})},register_on_event:function(e,r,i,s){n(t).on(e,r,function(){var e=[].splice.call(arguments,0);e.push(this);i.apply(s||this,e)})}},data:{viewModel:new function(){this.data=ko.observable();this.getData=function(){console.info("get in here",arguments)}},createDataObject:function(e,t,i){var s=this;if(n.type(t)=="string"){var o=r.get(t);o=r.utils.overwrite(o,i||{});o.init();return o}else{e=e.toLowerCase();i=t||{};if(!i.extend){i.extend="Firebrick."+e+".Base"}return r.classes.buildClass("Firebrick."+e+".Base",i)}},store:{createStore:function(e,t){return r.data.createDataObject("Store",e,t)},loadStore:function(e,t){var r=this,t=t||{};url=e.url;if(n.isPlainObject(url)){url=url.get}e.status="preload";n.ajax({datatype:e.datatype,async:n.type(t.async)=="boolean"?t.async:false,url:e.url,success:function(r,i,s){e.setData(r);e.status=i;if(n.isFunction(t.callback)){t.callback.apply(t.scope||e,[r,i,s])}},error:function(t,n,r){console.warn("unable to load store '",e.classname,"' with path:",e.url);console.error(n,r)}});return e},insert:function(e,t,n){var r=this;if(t==-1){e.data[e.root].push(n)}else{e.data[e.root].splice(t,0,n)}if(n&&n.isRecord){n.store=e;r.registerStoreRecordListeners(e,n)}e.fireEvent("recordInserted",e,n);e.fireEvent("storeUpdated",e,n);return e},registerStoreRecordListeners:function(e,t){t.bubbleEvents={};var n=function(){e.fireEvent("storeUpdated",e,t)};t.bubbleEvents["recordChanged"]=n;t.on("recordChanged",n);return e},removeRecordListeners:function(e,t){var r=this;n.each(t.bubbleEvents,function(e,n){t.off(e,n)});return e},add:function(e,t){var n=this;return n.insert(e,-1,t)},remove:function(e,t,r,i){var s=this;e.changedRecords=[];var o=s.findRecordAndExecute(e,"remove",t,r,i);if(e.changedRecords.length>0){e.fireEvent("recordRemoved",e,e.changedRecords);e.fireEvent("storeUpdated",e,e.changedRecords);n.each(e.changedRecords,function(t,n){s.removeRecordListeners(e,n)});e.changedRecords=[]}return e},removeAll:function(e,t,n){return this.remove(e,t,n,true)},findRecord:function(e,t,n){return this.findRecordAndExecute(e,"find",t,n)},findAllRecords:function(e,t,n){return this.findRecordAndExecute(e,"find",t,n,true)},findRecordAndExecute:function(e,t,r,i,s){s=s===true?s:false;var o=[],u=e.getRoot();var a=function(s){if(n.isPlainObject(s)&&s.isRecord){if(r=="recordId"&&s.recordId==i||s.data.hasOwnProperty(r)&&s.data[r]==i){if(t=="remove"){e.changedRecords.push(s)}else if(t=="find"){return s}}else{if(t=="remove"){return s}}}};o=u.filter(a);if(t=="remove"){e.data[e.root]=o}return o},setDataForStore:function(e,t){var r=this;if(n.isArray(t)){t={root:t}}if(t[e.root]){t[e.root]=r.convertToRecords(e,t[e.root]);e.data=t}else{console.info("store root was not found in the specified data:",e.root,e)}return e},convertToRecords:function(e,t){var i=this,s;n.each(t,function(s,o){if(n.isPlainObject(o)){n.each(o,function(t,r){if(n.isArray(r)){o[t]=i.convertToRecords(e,r)}})}t[s]=r.createRecord().setData(o)});return t},submit:function(e,t){var r=this,i;if(e&&e.url&&e.url.submit){e.status="presubmit";i=e.toJson();n.ajax({url:e.url.submit,data:{data:i},type:e.protocol,beforeSend:function(){return e.fireEvent("beforeSubmit",e,i)},success:function(n,r,i){e.status=r;if(t){t.apply(e,arguments)}},error:function(){console.error("error submitting data for store to url",e.url.submit,e)}})}else{console.error("unable to submit store, no submit path found (url.submit)",e)}return e}},convertToPlainObject:function(e){var t=this,r;if(n.isArray(e)){r=[];n.each(e,function(e,n){r.push(t.convertToPlainObject(n))})}else if(n.isPlainObject(e)){if(e.isRecord){e=e.data}r={};n.each(e,function(e,n){r[e]=t.convertToPlainObject(n)})}else{r=e}return r},record:{createRecord:function(e,t){return r.data.createDataObject("Record",e,t).init()}}},router:{onHashChange:function(t){n(e).on("hashchange",function(){t.apply(this,arguments)})},is:function(t){if(t.contains("#")){return e.location.hash==t}return e.location.href.replace(e.location.origin)==t}}};r.define("Firebrick.class.Base",{init:function(){return this},localEventId:0,localEventRegistry:{},bubbleEvents:{},hasDependencies:function(){var e=this;return e.require&&(n.type(e.require)=="string"||n.isArray(e.require)&&e.require.length>0)},on:function(e,t){var n=this;if(!n.localEventRegistry[e]){n.localEventRegistry[e]=[]}t.id=n.localEventId;localEventId=n.localEventId++;n.localEventRegistry[e].push(t);return n},off:function(e,t){var r=this;if(r.localEventRegistry[e]){n.each(r.localEventRegistry[e],function(n,i){if(i.id==t.id){r.localEventRegistry[e].splice(n,1);return false}})}return r},fireEvent:function(){var e=this,t=arguments,r=[].splice.call(arguments,0,1);if(e.localEventRegistry[r]){n.each(e.localEventRegistry[r],function(e,n){n.apply(n,t)})}return e}});r.define("Firebrick.view.Base",{extend:"Firebrick.class.Base",tpl:"",store:null,html:"",target:null,autoRender:true,controller:null,loadingTpl:r.templates.loadingTpl,showLoading:true,state:"initial",init:function(){var e=this;e.initStore();e.initView(e.tpl,e.getData());return e.callParent()},getStore:function(){return this.store},getData:function(){return this.getStore().data},initView:function(e,t){var n=this;n.html=e;if(n.autoRender){n.render()}return n},getTarget:function(){return r.view.getTarget(this.target)},render:function(){return this.renderTo()},renderTo:function(e){var t=this,i=t.target,e=t.getTarget(e);ko.cleanNode(e[0]);if(e){r.view.renderTo(e,t.html);if(t.state=="initial"){var s=t.getData();if(n.isArray(s)){s={items:s}}t.koData=ko.mapping.fromJS(s);ko.applyBindings(t.koData,e[0]);t.state="rendered"}else if("rendered"){ko.applyBindings(t.koData,e[0])}t.fireEvent("viewRendered",t)}else{console.warn("unable to render, no target found for",i||t.target,this)}return t},initStore:function(){var e=this;e.store=e.store||{};if(!e.store.isStore){e.store=r.createStore({data:e.store})}return e},refresh:function(e){var t=this,r=t.getStore();if(e&&r){n.each(e,function(e,t){r.data[e]=t})}t.init();t.render();return t}});r.define("Firebrick.controller.Base",{extend:"Firebrick.class.Base",require:[],init:function(){return this.callParent()},app:{on:function(){return r.events.on.apply(r.events,arguments)},listeners:function(){return r.events.addListener.apply(r.events,arguments)}}});r.define("Firebrick.store.Base",{extend:"Firebrick.class.Base",init:function(){var e=this;if(!e.dataInitialised&&e.data){e.setData(e.data)}return this.callParent()},datatype:"json",url:{get:null,submit:null},protocol:"POST",status:"initial",isStore:true,root:"root",dataInitialised:false,load:function(e){return r.data.store.loadStore(this,e)},remove:function(e,t){var n=this;return r.data.store.remove(n,e,t)},removeAll:function(e,t){var n=this;return r.data.store.removeAll(n,e,t)},getData:function(){return this.data},setData:function(e){var t=this;r.data.store.setDataForStore(t,e);t.dataInitialised=true;return t},insert:function(e,t){var n=this;return r.data.store.insert(n,e,t)},add:function(e){var t=this;return r.data.store.add(t,e)},findRecord:function(e,t){var n=this;return r.data.store.findRecord(n,e,t)},findAllRecords:function(e,t){var n=this;return r.data.store.findAllRecords(n,e,t)},findAll:function(){return this.getRoot()},getRoot:function(){return this.data[this.root]},size:function(){var e=this;if(n.isArray(e.getRoot())){return e.getRoot().length}return 0},submit:function(){return r.data.store.submit(this)},toPlainObject:function(){return r.data.convertToPlainObject(this.data)},toJson:function(){return JSON.stringify(this.toPlainObject())}});r.define("Firebrick.record.Base",{extend:"Firebrick.class.Base",recordId:null,data:null,isRecord:true,init:function(){var e=this;e.data=e.data||{};e.recordId=r.utils.uniqId();return this.callParent()},getDataId:function(){var e=this;if(e.data&&e.data.id){return e.data.id}return},getId:function(){return this.recordId},addData:function(e){var t=this;if(n.isArray(t.data)){t.data.push(e)}else if(n.isPlainObject(t.data)){n.each(e,function(e,n){t.data[e]=n})}else{t.data=e}return t},setData:function(e){var t=this;t.data=e;return t},getData:function(e){var t=this;if(e){return t.formatter(t.data[e])}return t.data},setValue:function(e,t){var n=this;if(n.data){if(n.data[e]!==t){n.data[e]=t;n.fireEvent("recordChanged",n,e,t)}}return n},formatter:function(e){return e},toPlainObject:function(){return r.data.convertToPlainObject(this.data)},toJson:function(){return JSON.stringify(this.toPlainObject())}});e.Firebrick=r})(window,document,jQuery)