/**
* Firebrick JS - JavaScript MVC Framework powered by jQuery, Bootstrap, Knockout JS and Require JS
* Author: Steven Masala
* dependencies: jquery, bootstrap, knockout js, requirejs
* contact: me@smasala.com
*/ 

(function(e,t){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","knockout","knockout-mapping"],function(e,n,r){n.mapping=r;return t(e,n)})}else{t(e.jQuery,e.ko)}})(this,function(e,t){if(window.Firebrick||window.fb){console.error("unable to initialise FirebrickJS, window.Firebrick or window.fb are already defined");return}var n={version:"0.7.7",app:{name:"",path:""},ready:function(t){var r=this;r.app=t.app;r.utils.initSplash(t.splash||r.templates.loadingTpl);n.boot.prepApplication(t);if(t.require&&t.require.length>0){if(!e.isArray(t.require)){t.require=[t.require]}require(t.require,function(){r.utils.clearSplash();t.go.apply(t.go,arguments)})}else{r.utils.clearSplash();t.go()}},shortcut:function(e,t,n){return e[t].apply(e,n)},get:function(){return this.shortcut(this.classes,"get",arguments)},getById:function(){return this.shortcut(this.classes,"getById",arguments)},create:function(){return this.shortcut(this.classes,"create",arguments)},define:function(){return this.shortcut(this.classes,"define",arguments)},require:function(){return this.shortcut(this.utils,"require",arguments)},getView:function(){return this.shortcut(this.views,"getView",arguments)},loadRaw:function(){return this.shortcut(this.views,"loadRaw",arguments)},getViewById:function(){return this.shortcut(this.views,"getViewById",arguments)},createView:function(){return this.shortcut(this.views,"createView",arguments)},defineView:function(){return this.shortcut(this.views,"defineView",arguments)},getBody:function(){return this.shortcut(this.views,"getBody",arguments)},delay:function(){return this.shortcut(this.utils,"delay",arguments)},addListener:function(){return this.shortcut(this.events,"addListener",arguments)},removeListener:function(){return this.shortcut(this.events,"removeListener",arguments)},fireEvent:function(){return this.shortcut(this.events,"fireEvent",arguments)},on:function(){return this.shortcut(this.events,"on",arguments)},off:function(){return this.shortcut(this.events,"off",arguments)},createStore:function(){return this.shortcut(this.data.store,"createStore",arguments)},text:function(){return this.shortcut(this.languages,"getByKey",arguments)},classes:{classRegistry:{},get:function(e,t){return this.createClass(e,t)},getById:function(t){var n=this,r;e.each(n.classRegistry,function(e,n){if(n.getClassId&&n.getClassId()==t){r=n;return false}});return r},create:function(e,t){var n=this,r=n.define(e,t);if(r&&r.init&&!r._created){r.init()}return r},createClass:function(t,r){var i=this,s=i.classRegistry[t];if(e.isPlainObject(t)){return t}if(s&&r){s=n.utils.extend(s,r);i.classRegistry[t]=s}return s},define:function(e,t){var n=this,r=n.buildClass(e,t);n.classRegistry[e]=r;return r},buildClass:function(e,t){var r=this,t=t||{};if(t.extend){var i=r.classRegistry[t.extend];if(i){t=n.utils.extend(t,i);t._super=i}else{console.warn("unable to build class or inherit from:",t.extend)}}t._classname=e;return t}},templates:{loadingTpl:"<div class='fb-view-loader'><span class='glyphicon glyphicon-refresh glyphicon-refresh-animate'></span></div>"},views:{viewRegistry:{},bootView:function(e){n.utils.clearSplash();return n.createView(n.app.name+".view.Index",{target:"body",store:e.viewData,async:true})},getView:function(e){return this.viewRegistry[e]},getViewById:function(t){var n=this,r;e.each(n.viewRegistry,function(e,n){if(n.getClassId&&n.getClassId()==t){r=n;return false}});return r},createView:function(e,t){var n=this,r=n.defineView(e,t);if(!r._created){r.init()}else if(r.autoRender){r.render();r.initSubViews()}return r},defineView:function(e,t){var r=this;if(!r.viewRegistry[e]){t=r.basicViewConfigurations(t);var i=n.classes.buildClass(e,t);r.viewRegistry[e]=i}return r.viewRegistry[e]},initSubViews:function(t){var n=this,r=t.subViews;if(r){if(e.isArray(r)){e.each(r,function(e,r){t.subViews[e]=n.internal_loadSubView(r)})}else{t.subViews=n.internal_loadSubView(r)}}return t},internal_loadSubView:function(t){if(e.type(t)=="string"){t=n.createView(t,{autoRender:false})}else if(e.isPlainObject(t)){if(t.isView){t=n.createView(t._classname)}}return t},loadRaw:function(e){var t=this,r;n.utils.require(e,function(e){r=e},false,"html","html");return r},basicViewConfigurations:function(e){var t=this;e=e||{};if(!e.extend){e.extend="Firebrick.view.Base";if(!e.init){e.init=function(){return this.callParent()}}}return e},body:null,getBody:function(t){var n=this;if(t===true||!n.body){n.body=e("body")}return n.body},getTarget:function(t){var n=t&&t.jquery?t:e(t);return n.length>0?n:null},renderTo:function(e,t){return e.html(t)}},boot:{prepApplication:function(e){if(e.cache===false){require.config({urlArgs:"fireb="+(new Date).getTime()})}if(e.dev){requirejs.onError=function(e){if(e.requireType==="timeout"){console.log("modules: "+e.requireModules)}else{console.error(e.message)}}}if(e.lang){n.languages.init(e.lang)}if(e.autoRender!==false){n.views.bootView(e)}}},utils:{requiredFiles:{},intervalRegistry:{},splashCleared:false,initSplash:function(t){var r=this;n.delay(function(){if(!r.splashCleared){e("html").append("<div id='fb-splash'>"+t+"</div>")}},1)},clearSplash:function(){this.splashCleared=true;e("#fb-splash").remove()},extend:function(t,n){var r=this;e.each(n,function(n,r){if(!t.hasOwnProperty(n)){t[n]=r}else{if(e.isFunction(t[n])){(function(e,r){t[n]=function(){this.callParent=r;var t=e.apply(this,arguments);delete this.callParent;return t}})(t[n],r)}}});return t},overwrite:function(t,n){e.each(n,function(e,n){t[e]=n});return t},delay:function(e,t,n,r){setTimeout(function(t){e.apply(r||this,t)},t,n)},clearInterval:function(e){var t=this,n=t.intervalRegistry[e];if(n){window.clearInterval(n.intId);delete this.intervalRegistry[e]}},setInterval:function(){var t=this,n=arguments[0];id=e.isFunction(n)?n.id:n;if(!t.isIntervalRunning(id)){if(e.isFunction(n)){newId=t.int_applyInterval(null,arguments[0],arguments[1],arguments[2])}else{newId=t.int_applyInterval.apply(this,arguments)}}return newId},int_applyInterval:function(e,t,n,r){var i=this,e=e||i.uniqId();var s=function(){t.id=e;t.apply(r||t,arguments)};s.intId=window.setInterval(s,n);i.intervalRegistry[e]=s;return e},isIntervalRunning:function(e){return this.intervalRegistry[e]},clone:function(t,n){var r={},n=n||{};e.each(t,function(e,t){r[e]=t});e.each(n,function(e,t){r[e]=t});return r},require:function(t,n,r,i,s){var o=this,u,i=i||"script",s=s||"js";if(!e.isArray(t)){t=[t]}var a=t;t=a.filter(function(e){return!o.requiredFiles[e]});var f=t.length,l=function(){f--;if(f==0){if(n&&e.isFunction(n)){n.apply(this,arguments)}}};for(var c=0,h=t.length;c<h;c++){o.requiredFiles[t[c]]=true;u=o.getPathFromName(t[c],s);e.ajax({async:e.type(r)=="boolean"?r:true,dataType:i,url:u+"?fb"+(new Date).getTime(),success:function(){l.apply(this,arguments)},error:function(e,n,r){console.warn("unable to load file/class '",t[c],"' at:",u);console.error(n,r);l.apply(this,arguments)}})}return t},getPathFromName:function(e,t){var r=this,i=n.app.path,s=n.app.name,t=t||"js";if(i.charAt(i.length-1)=="/"){i=i.substr(0,i.length-1)}e=e.trim();if(e.indexOf(".")>0){if(e.indexOf(s)==0){e=e.replace(s,i);return e.replace(/\./g,"/")+"."+t}}return i+"/"+e},globalC:1,uniqId:function(){var e=this,t=new Date,n=t.getMilliseconds()+"",r=++t+n+(++e.globalC===1e4?e.globalC=1:e.globalC);return r},loadCSS:function(e){var t=document.createElement("link");t.type="text/css";t.rel="stylesheet";t.href=e;document.getElementsByTagName("head")[0].appendChild(t)}},languages:{lang:t.observable("en"),keys:t.observable({}),init:function(t){var r=this;if(e.type(t)=="string"){n.createStore({url:t,autoLoad:false}).load({callback:function(){r.keys(this.getData())}})}else if(t.isStore){r.keys=t.getData()}else{console.error("unable to load languages",t)}},getByKey:function(e){var t=this;e=e.toLowerCase(),a=t.keys()[t.lang()];return a&&a[e]?a[e]:e},setLang:function(e){this.lang(e)},getLang:function(){return this.lang()},allLanguages:function(){var n=this,r=[];e.each(t.mapping.toJS(n.keys),function(e,t){r.push(e)});return r}},events:{eventRegistry:{},eventCounter:0,addListener:function(t,n,r){var i=this;if(e.isPlainObject(t)){return i.addListener_internal(t)}if(!n.conf){n.conf={};n.conf.callbackId=i.eventCounter++}n.conf.scope=r;if(!i.eventRegistry[t]){i.eventRegistry[t]=[]}i.eventRegistry[t].push(n);return n},addListener_internal:function(t){var n=this,r=t.scope;delete t.scope;e.each(t,function(e,t){n.addListener(e,t,r)})},removeListener:function(e,t){var n=this,r=n.eventRegistry[e];if(r){if(t.conf.callbackId||t.conf.callbackId==0){for(var i=0,s=r.length;i<s;i++){if(r[i].conf.callbackId==t.conf.callbackId){r.splice(i,1);if(r.length==0){delete n.eventRegistry[e]}}}}else{console.warn("No callbackId for function whilst trying to remove listener")}}else{console.warn("Unable to remove listener. No events found for:",e)}},fireEvent:function(e,t){var n=this,r=n.eventRegistry[e];if(r){var i=[].splice.call(arguments,1),s=n.createEventData(e);for(var o=0,u=r.length;o<u;o++){var a=r[o];s.conf=a.conf;s.funct=a;i.unshift(s);a.apply(a.conf.scope||window,i)}}},createEventData:function(e){var t=this,n={event:e,conf:null,removeSelf:function(){t.removeListener(e,n.funct)}};return n},on:function(t,n,r,i){var s=this;if(e.isPlainObject(t)){return s.on_internal(t)}return s.register_on_event(t,n,r,i)},off:function(t,n,r){e(document.body).off(t,n,r)},on_internal:function(t){var n=this,r=t.scope;e.each(t,function(t,i){if(t!="scope"){e.each(i,function(e,i){n.register_on_event(e,t,i,r)})}})},register_on_event:function(t,n,r,i){e(document).on(t,n,function(){var e=[].splice.call(arguments,0);e.push(this);r.apply(i||this,e)})}},data:{store:{createStore:function(t,r){var i=this;if(e.type(t)=="string"){var s=n.get(t);s=n.utils.overwrite(s,r||{});s.init();return s}else{r=t||{};if(!r.extend){r.extend="Firebrick.store.Base"}return n.classes.buildClass("Firebrick.store.Base",r).init()}},loadStore:function(t,n){var r=this,n=n||{};url=t.url,async=n.async;if(e.type(async)!="boolean"){async=t.async}if(e.isPlainObject(url)){url=url.get}t.status="preload";e.ajax({datatype:t.datatype,async:async,url:t.url,success:function(r,i,s){t.setData(r);t.status=i;if(e.isFunction(n.callback)){n.callback.apply(n.scope||t,[t,r,i,s])}},error:function(e,n,r){console.warn("unable to load store '",t.classname,"' with path:",t.url);console.error(n,r)}});return t},submit:function(t,n){var r=this,i;if(t&&t.url&&t.url.submit){t.status="presubmit";i=t.toJson();e.ajax({url:t.url.submit,data:{data:t.toJson()},type:t.protocol,beforeSend:function(){return t.fireEvent("beforeSubmit",t,i)},success:function(e,r,i){t.status=r;if(n){n.apply(t,arguments)}},error:function(){console.error("error submitting data for store to url",t.url.submit,t)}})}else{console.error("unable to submit store, no submit path found (url.submit)",t)}return t}}},router:{set:function(t,r){var i=this,s=function(){};if(e.isFunction(t)){s=t}else{if(e.isPlainObject(t)){s=function(){e.each(t,function(e,t){if(n.router.is("#"+e)){t.apply(this,arguments);return false}})}}}return i.onHashChange(s)},onHashChange:function(t){return e(window).on("hashchange",function(){t.apply(this,arguments)})},is:function(e){if(e.contains("#")){return window.location.hash==e}return window.location.href.replace(window.location.origin)==e}}};n.define("Firebrick.class.Base",{init:function(){var e=this;if(e.listeners){e.on(e.listeners)}e.fireEvent(e.overrideReadyEvent||"ready");e._created=true;return e},destroy:function(){var e=this;e.fireEvent("destroyed",e);delete e.localEventRegistry[e.getClassId()];e._created=false},_created:false,_classId:null,localEventRegistry:{},getClassId:function(){if(!this._classId){this._classId="fb-"+n.utils.uniqId()}return this._classId},listeners:null,on:function(t,r,i){var s=this,o=this.getClassId();if(!s.localEventRegistry[o]){s.localEventRegistry[o]={}}var u=function(e,t,r){if(!s.localEventRegistry[o][e]){s.localEventRegistry[o][e]=[]}t.id=n.utils.uniqId();if(r){t.scope=r}s.localEventRegistry[o][e].push(t)};if(e.isPlainObject(t)){var a=t.scope;e.each(t,function(e,t){if(e!=="scope"){u(e,t,a)}})}else{u(t,r,i)}return s},off:function(t,n){var r=this,i=r.getClassId();if(r.localEventRegistry[i]&&r.localEventRegistry[i][t]){e.each(r.localEventRegistry[i][t],function(e,s){if(s.id==n.id){r.localEventRegistry[i][t].splice(e,1);return false}})}return r},fireEvent:function(){var t=this,n=t.getClassId(),r=t.localEventRegistry[n],i=arguments,s=arguments[0];if(r&&r[s]){e.each(r[s],function(e,t){t.apply(t.scope||t,i)})}return t}});n.define("Firebrick.view.Base",{extend:"Firebrick.class.Base",tpl:"",store:null,html:"",target:null,autoRender:true,controller:null,loadingTpl:n.templates.loadingTpl,loading:false,showLoading:true,state:"initial",subViews:null,isView:true,viewExtension:"html",async:true,_init:function(e){var t=this;if(t.autoRender){t.startLoader()}var r=n.utils.require(t._classname,function(n){t.tpl=n;e.call()},t.async,"html",t.viewExtension);if(!r.length){e.call()}return this},init:function(){var e=this;e.overrideReadyEvent="base";e.on(e.overrideReadyEvent,function(){e._init(function(){e.initStore();e.initView(e.tpl,e.getData());e.initSubViews();e.fireEvent("ready")})});return e.callParent()},getStore:function(){return this.store},getData:function(){return this.getStore().getData()},initView:function(e,t){var n=this;n.html=e;if(n.autoRender){n.render()}return n},initSubViews:function(){return n.views.initSubViews(this)},getTarget:function(){return n.views.getTarget(this.target)},unbind:function(){var e=this,n=e.getTarget();if(n&&n.attr("fb-view-bind")){var r=n[0];t.cleanNode(r);n.removeAttr("fb-view-bind")}},bind:function(){var r=this,i=r.getTarget();if(i&&!i.attr("fb-view-bind")){var s=i[0];n.views.renderTo(i,r.html);r.hide();r.state="rendered";var o=r.getData();if(o&&!e.isEmptyObject(o)){i.attr("fb-view-bind",r.getClassId());t.applyBindings(o,s);r.setDisposeCallback(s)}r.stopLoader();r.show();r.fireEvent("rendered",r)}},render:function(){var e=this,t=e.target,n=e.getTarget();if(n){e.unbind();e.bind()}else{console.warn("unable to render, no target found for",e.target,this)}return e},setDisposeCallback:function(r){t.utils.domNodeDisposal.addDisposeCallback(r,function(t){var r=n.getViewById(e(t).attr("fb-view-bind"));r.destroy()})},show:function(){var e=this,t=e.getTarget();if(t){t.show()}},hide:function(){var e=this,t=e.getTarget();if(t){t.hide()}},isVisible:function(){var e=this,t=e.getTarget();if(t){return t.is(":visible")}return false},initStore:function(){var e=this;e.store=e.store||{};if(!e.store.isStore){e.store=n.createStore({data:e.store})}return e},update:function(e){var t=this;t.getStore().setData(e);return t},startLoader:function(){var e=this,t=e.getTarget();if(!e.loading&&t){e.loading=true;n.delay(function(){if(e.loading){e.hide();t.before("<div id='fb-loader-"+e.getClassId()+"'>"+e.loadingTpl+"</div>")}},1)}},stopLoader:function(){var t=this;if(t.loading){e("#fb-loader-"+t.getClassId()).remove();t.show();t.loading=false}}});n.define("Firebrick.controller.Base",{extend:"Firebrick.class.Base",init:function(){return this.callParent()},app:{on:function(){return n.events.on.apply(n.events,arguments)},listeners:function(){return n.events.addListener.apply(n.events,arguments)}}});n.define("Firebrick.store.Base",{extend:"Firebrick.class.Base",init:function(){var e=this;if(!e.dataInitialised){if(e.autoLoad){e.load()}else{if(e.data){e.setData(e.data)}}}return this.callParent()},datatype:"json",url:{get:null,submit:null},protocol:"POST",status:"initial",isStore:true,dataInitialised:false,autoLoad:false,data:null,_initialData:null,async:true,root:null,load:function(e){return n.data.store.loadStore(this,e)},getData:function(){var t=this;if(t.root){if(e.isPlainObject(t.data)){return e.isFunction(t.data[t.root])?t.data[t.root]():t.data[t.root]}}return t.data},getRawData:function(n){var r=this;if(n){return r._initialData}var i=r.getData();i=e.isFunction(i)?i():i;return t.toJS(i)},setData:function(e){var n=this;if(!n.dataInitialised){if(!e.__ko_mapping__){n._initialData=e;e=t.mapping.fromJS(e)}n.data=e;n.dataInitialised=true}else{if(!e.__ko_mapping__){n._initialData=e;t.mapping.fromJS(e,n.data)}else{console.error("cannot update store data using a mapped object",e)}}return n},submit:function(){return n.data.store.submit(this)},toPlainObject:function(){return e.isFunction(me.data)?t.toJS(me.data):me.data},toJson:function(){return JSON.stringify(this.toPlainObject())}});window.Firebrick=n;window.fb=window.Firebrick})